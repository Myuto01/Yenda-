{% extends 'base.html' %}
{% load static %}
{% block content %}
<html>
<title>{% block title %}Yenda| Search-Result{% endblock %}</title>
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}">
<style>
    .header-container {
        background: rgb(219, 218, 218);
        text-align: center;
        margin-bottom: 50px;
    }

    .header-container .date {
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 10px;
    }

    .header-container .result-container {
        font-size: 15px;
    }

    .header-container .result-container .result-text {
        display: flex;
        flex-direction: row;
        gap: 10px;
        justify-content: center;
        margin-bottom: 10px;
    }

    .header-container .result-container .result-text .fa {
            font-weight: lighter;
    }

    .card {
        display: flex;
        align-items: center;
        width: 660px;
        margin: 20px auto;
        padding: 20px;
        margin: auto auto;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px dashed #999;
    }

    
    .time-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
    }

    .time-difference {
        text-align: center;
        margin-top: 8px;
    }

    .line {
        flex-grow: 1;
        height: 1px;
        width: 200px;
        background-color: #000;
    }

    .dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        background-color: #000; /* Black color for the dot */
        border-radius: 50%;
        margin: 0 10px;
    }

    .departure_time {
        margin-right: 10px;
    }

    .arrival_time {
        margin-left: 10px;
    }

    .operator_container {
        display: flex;
        flex-direction: row;
        gap: 340px;
    }

    .operator {
        border: 1px solid black;
        border-radius: 20px;
        background: grey;
        color: blueviolet;
        font-weight: bold;
        padding: 0px 20px 0px 20px 
    }

    .price-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
    }

    .price {
        border: 1px solid blueviolet;
        background: blueviolet;
        color: white;
        padding: 0px 5px 0px 5px;
        
    }

    .card {
      color: black; /* Set the text color to black for all elements within the card */
    }

    a:hover {
        text-decoration: none;
    }

    .fas.fa-bookmark {
        color: #888; /* Default color for non-bookmarked state */
    }

    /* Style for the bookmarked state */
    .fas.fa-bookmark.bookmarked {
        color: black; /* Customize the color for the bookmarked state */
    }
</style>
<body>

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}


    <div class="header-container">
        <div class="date" id="displayedDate">
            <!-- The date will be displayed here -->
        </div>
        <div class="result-container">
            <div class="result-text">
                <span id="displayedDate"></span>
                <span id="displayCurrentLocation"></span> <i class="fas fa-arrow-right"></i> <span id="displayDestination"></span>
            </div>
        </div> 
    </div>

    <h1>Courier Results</h1>

    {% if results %}
    <ul>
        {% for result in results %}
            <li>
                <a href="{% url 'app:select_tickets' result.id %}">
                    <div class="card">
                        <div class="time-container">
                            <strong class="time departure"><strong class="departure_time">{{ result.departure_time }}</strong></strong>
                            <div class="line"></div>
                            <div class="dot"></div>
                            <div class="line"></div>&nbsp;
                            <strong class="time arrival"><strong class="arrival_time">{{ result.estimated_arrival_time }}</strong></strong>
                        </div>
                        <p class="time-difference">
                            <span class="time-difference-span"></span>
                        </p>  
                        <div class="operator_container">             
                            <p class="operator">{{ result.bus_operator.username }}</p>
                            <div class="price-container">
                                <p class="price"><strong>K</strong> {{ result.price }} </p>
                                <a href="#" class="bookmark-trigger" data-trip-id="{{ result.id }}"> <i class="fas fa-bookmark {% if result.bookmarked %}bookmarked{% endif %}"></i></a>
                            </div>
                        </div> 
                    </div>
                </a>
            </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No results found.</p>
    {% endif %}

      <script>
        // Retrieve values from localStorage
        var currentLocation = localStorage.getItem('currentLocation');
        var destination = localStorage.getItem('destination');
        var storedDate = localStorage.getItem('selectedDate');

        // Display values in the designated spans
        document.getElementById('displayCurrentLocation').innerText = currentLocation;
        document.getElementById('displayDestination').innerText = destination;

        // Format the date
        var formattedDate = formatDateString(storedDate);

        // Display the formatted date
        document.getElementById('displayedDate').innerText = formattedDate;

        // Function to format the date string
        function formatDateString(dateString) {
            var options = { weekday: 'long', day: 'numeric', month: 'long' };
            var date = new Date(dateString);
            return date.toLocaleDateString('en-US', options);
        }
    </script>

    <script>
    // Inside the forEach loop
    // Retrieve or define cardContainers before this point
    var cardContainers = document.querySelectorAll(".card");

    // Ensure cardContainers is defined and not empty
    if (cardContainers && cardContainers.length > 0) {
        // Inside the forEach loop
        cardContainers.forEach(function (cardContainer) {
            var departureElement = cardContainer.querySelector(".time.departure");
            var arrivalElement = cardContainer.querySelector(".time.arrival");

            var departureTimeText = departureElement.textContent.trim();
            var arrivalTimeText = arrivalElement.textContent.trim();

            var departureTime = parseTime(departureTimeText);
            var arrivalTime = parseTime(arrivalTimeText);

            var timeDifference = arrivalTime - departureTime;

            // Calculate hours and minutes
            var hours = Math.floor(timeDifference / (1000 * 60 * 60));
            var minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

            // Display the time difference in the correct span
            var timeDifferenceSpan = cardContainer.querySelector(".time-difference-span");
            timeDifferenceSpan.textContent = hours + " h " + minutes;

            // Log the time difference for debugging
            console.log("Time difference:", hours, "h", minutes);
        });

        // Log a message after the forEach loop
        console.log("Script executed successfully");
    } else {
        console.error("cardContainers is not defined or empty");
    }

    // Function to parse time string and return Date object
    function parseTime(timeString) {
        // Example: timeString is in the format "4:58 a.m."
        var timeComponents = timeString.split(" ");
        var time = timeComponents[0].split(":");
        var hours = parseInt(time[0]);
        var minutes = parseInt(time[1]);

        if (timeComponents[1] === "p.m." && hours !== 12) {
            hours += 12;
        } else if (timeComponents[1] === "a.m." && hours === 12) {
            hours = 0;
        }

        return new Date(0, 0, 0, hours, minutes);
    }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var bookmarkTriggers = document.querySelectorAll('.bookmark-trigger');
        
            bookmarkTriggers.forEach(function(trigger) {
                trigger.addEventListener('click', function(event) {
                    event.preventDefault();
        
                    var tripId = this.getAttribute('data-trip-id');
                    var bookmarkIcon = this.querySelector('.fas.fa-bookmark');
        
                    // Toggle the 'bookmarked' class
                    bookmarkIcon.classList.toggle('bookmarked');
        
                    // Send the bookmark status to the server
                    fetch('{% url "app:update_bookmark_status" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: 'trip_id=' + encodeURIComponent(tripId) + '&bookmarked=' + bookmarkIcon.classList.contains('bookmarked'),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response from the server if needed
                        if (data.success) {
                            // Optionally, redirect to the bookmarked trips page when a trip is bookmarked
                            if (bookmarkIcon.classList.contains('bookmarked')) {
                                window.location.href = '{% url "app:bookmarked_trips" %}';
                            }
                        } else {
                            // Handle errors from the server
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        });
        </script>

{% endblock %}